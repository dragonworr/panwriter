<html>
<head>
<!--
Unfortunately, this breaks paged.js,
which uses https://github.com/facebook/regenerator/,
which uses `Function("return this")`,
which is a form of `eval()`.
Probably fixed in https://github.com/facebook/regenerator/commit/4efc6899803c087af25021fae1d557004b192e24

It's not so bad, since markdown-it has raw HTML disabled.

<meta http-equiv="Content-Security-Policy" content="script-src 'self'">
-->
<link rel="stylesheet" href="../node_modules/katex/dist/katex.min.css">
<link rel="stylesheet" href="../node_modules/markdown-it-texmath/css/texmath.css">
<style>
@media screen {
  body {
    margin: 0;
  }

  .pagedjs_pages {
    overflow: scroll;
    padding: 90px 50px 50px 50px;
  }

  .pagedjs_page {
    background-color: white;
    margin: 0 auto;
    margin-bottom: 50px;
  }
}
</style>
</head>
<body>
  <script src="previewFrame.bundle.js"></script>
  <script>
  "use strict"
  
  let style, previewer;
  async function render(doc, paginated) {
    const content = doc.getHtml()
        , cssStr  = await doc.getCss()
        ;
    if (style) {
      style.remove();
    }
    if (previewer) {
      previewer.chunker.pageTemplate.remove();
      previewer.polisher.destroy();
    }

    let renderTo = document.body;
    if (paginated) {
      // render using paged.js

      // override body/margin user set on body, as it would mess up the preview
      renderTo.style = "margin: 0; padding: 0;"

      previewer = new Previewer();

      previewer.polisher.setup();
      style = previewer.polisher.insert("");

      let chunker = new Chunker();
      previewer.chunker = chunker;
      chunker.setup(renderTo);

      previewer.initializeHandlers();

      return previewer.polisher.convertViaSheet(cssStr, "").then(text => {
        style.innerHTML = text;
        return chunker.reflow(content);
      });
    } else {
      renderTo.style = ""
      // render without paded.js
      renderTo.innerHTML = ["<style>", cssStr, "</style>", content].join('');
    }
  }
  </script>
</body>
</html>
